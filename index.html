<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Лагерь: Сканер</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    /* твои стили без изменений */
  </style>
</head>
<body>
  <h2>Сканер лагеря</h2>
  <button id="scan-again">Сканировать снова</button>

  <div id="reader" playsinline style="width:360px; height:360px;"></div>

  <div id="child-card" style="display:none;">
    <!-- тут твои поля ФИО, Отряд, Баланс -->
  </div>

  <script>
    const qr = new Html5Qrcode("reader");
    let currentId = "";
    const sheetUrl = "https://script.google.com/macros/s/AKfycbxLNdtyoLOtF0MXn1yE5det2cr2kYcRY9q2SzzZcW5BmPiTqaQ1FddR2Wy_uNLmXXuw8w/exec";

    function onScanSuccess(decodedText) {
      qr.stop().catch(() => {});
      fetchChildData(decodedText.trim());
    }

    async function startScanner() {
      document.getElementById("child-card").style.display = "none";
      hideInputControls();

      try {
        await qr.start(
          { facingMode: "environment" },
          { fps: 7, qrbox: { width: 180, height: 180 } },
          onScanSuccess,
          (err) => {
            // ошибки сканирования можно просто логировать
            //console.log("Сканирование:", err);
          }
        );
      } catch (err) {
        alert("Не удалось открыть камеру. Разрешите доступ и попробуйте снова.");
        console.error(err);
      }
    }

    function fetchChildData(id) {
      fetch(`${sheetUrl}?id=${id}&action=get`)
        .then(res => res.json())
        .then(data => {
          currentId = id;
          document.getElementById("fio").textContent = data["ФИО"];
          document.getElementById("team").textContent = data["Отряд"];
          document.getElementById("balance").textContent = data["Баланс"];

          const card = document.getElementById("child-card");
          card.style.display = "none";
          void card.offsetWidth;
          card.style.display = "block";

          hideInputControls();
        })
        .catch(err => {
          alert("Ошибка получения данных: " + err);
        });
    }

    function showInputControls(sign) {
      const input = document.getElementById("amount");
      const apply = document.getElementById("btn-apply");

      input.style.display = "inline-block";
      apply.style.display = "inline-block";
      input.value = "";
      input.focus();

      apply.onclick = () => {
        const value = parseInt(input.value);
        if (isNaN(value) || value <= 0) {
          alert("Введите корректное число баллов");
          return;
        }
        updateBalance(value * sign);
        hideInputControls();
      };
    }

    function hideInputControls() {
      document.getElementById("amount").style.display = "none";
      document.getElementById("btn-apply").style.display = "none";
    }

    function updateBalance(delta) {
      fetch(`${sheetUrl}?id=${currentId}&action=update&delta=${delta}`)
        .then(res => res.text())
        .then(() => {
          const balance = document.getElementById("balance");
          balance.textContent = parseInt(balance.textContent) + delta;
        });
    }

    document.getElementById("btn-plus").addEventListener("click", () => showInputControls(1));
    document.getElementById("btn-minus").addEventListener("click", () => showInputControls(-1));
    document.getElementById("scan-again").addEventListener("click", startScanner);

    // Автоматический старт камеры при загрузке
    startScanner();
  </script>
</body>
</html>
